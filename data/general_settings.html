<!DOCTYPE html>
<html>

<head>
  <title>UI Settings</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="utf-8" />
</head>

<body>
  <form action="/settings" method="post">
    <table id="settingsTable" class="inlineTable">
      <tr>
        <th>General Settings</th>
      </tr>
      <tr>
        <td>Set Time Using</td>
        <td><button type="button" onclick="setTime(false)">
            System Time
          </button></td>
        <td><button type="button" onclick="setTime(true)">
            Custom Time
          </button></td>
      </tr>
      <tr>
        <td>Set Date Using</td>
        <td><button type="button" onclick="setDate(false)">
            System Date
          </button></td>
        <td><button type="button" onclick="setDate(true)">
            Custom Date
          </button></td>
      </tr>
      <tr>
        <td>Update Firmware</td>
        <td><input type="file" id="firmware" style="display:none;" onchange="uploadFirmware()"><button type="button"
            onclick="document.getElementById('firmware').click();">Upload</button></td>
      </tr>
      <tr>
        <td>Temperature Units</td>
        <td><input type="radio" name="temperature" value="0" %SETTINGS_CELCIUS_CHECKED%><label for="0">Celcius</label></td>
        <td><input type="radio" name="temperature" value="1" %SETTINGS_FREEDOMS_CHECKED%><label for="1">Freedoms</label></td>
      </tr>
      <tr>
        <td>Distance Units</td>
        <td><input type="radio" name="distance" value="0" %SETTINGS_KILOMETRES_CHECKED%><label for="0">Kilometres</label></td>
        <td><input type="radio" name="distance" value="1" %SETTINGS_MILES_CHECKED%><label for="1">Miles</label></td>
      </tr>
      <tr>
        <td><button type="submit" class="btn">
            Save
          </button></td>
      </tr>
    </table>
  </form>
  <br>
  <table class="inlineTable" id="ui_table">
    <tr>
      <th>UI Settings</th>
    </tr>
    %SETTINGS_SCREENS%
    <!-- <tr>
      <td>Screen 1</td>
      <td><button type="button" onclick="deleteScreen(this)">Delete</button></td>
      <td><button type="button" onclick="editScreen(this)">Edit</button></td>
      <td><button onclick="moveScreenUp(this)">↑</button></td>
      <td><button onclick="moveScreenDown(this)">↓</button></td>
    </tr> -->
    <tr>
      <form action="/new_screen" method="POST"><td><button type="submit" class="btn">New</button></td></form>
    </tr>
  </table>

  <script>
    function setTime(custom) {
      var date = new Date();

      if (custom) {
        var custom_time;
        while (custom_time == null) {
          custom_time = prompt("Set to (24hr time)", "hh:mm:ss");

          if (custom_time == null)  // Cancel the prompt if the user selects cancel
            return;

          custom_time = custom_time.match(/\b([0-1]?\d|2[0-3])\:[0-5]?\d\:[0-5]?\d\b/);
        }

        custom_time = custom_time[0]

        date.setHours(custom_time.substring(0, custom_time.indexOf(":")));
        date.setMinutes(custom_time.substring(custom_time.indexOf(":") + 1, custom_time.lastIndexOf(":")));
        date.setSeconds(custom_time.substring(custom_time.lastIndexOf(":") + 1));
      }
      if (confirm("Set to " + date.toTimeString().slice(0, 8)) == false) {
        return;
      }

      xhttp = new XMLHttpRequest();
      formData = new FormData();

      formData.append("hours", date.getHours());
      formData.append("minutes", date.getMinutes());
      formData.append("seconds", date.getSeconds());

      xhttp.open("POST", "set_time");
      xhttp.send(formData);
    }
    function setDate(custom) {
      var date = new Date();

      if (custom) {
        var custom_time;
        while (custom_time == null) {
          custom_time = prompt("Set to", "yy/mm/dd");

          if (custom_time == null)
            return;

          custom_time = custom_time.match(/\b\d\d\/(0?\d|1[0-2])\/([0-2]?\d|3[0-2])\b/);
        }

        custom_time = custom_time[0]

        date.setFullYear("20" + custom_time.substring(0, custom_time.indexOf("/")),
          custom_time.substring(custom_time.indexOf("/") + 1, custom_time.lastIndexOf("/")),
          custom_time.substring(custom_time.lastIndexOf("/") + 1));
        confirm("Set to " + date.getFullYear() + "/" + date.getMonth() + "/" + date.getDate());
      } else if (!confirm("Set to (yy/mm/dd) " + date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate())) {
        return;
      }

      xhttp = new XMLHttpRequest();
      xhttp.open("POST", "set_date");
      xhttp.send("year=" + date.getFullYear() + "&month=" + date.getMonth() + "&day=" + date.getDate() + "&weekday=" + date.getDay());
    }
    function uploadFirmware() {
      console.log("uploadFirmware");
      firmware = document.getElementById("firmware").files[0];  // file from input
      req = new XMLHttpRequest();
      formData = new FormData();

      formData.append("firmware", firmware);
      req.open("POST", "update");
      req.send(formData);
    }
    function moveScreenUp(elem) {
      var row = elem.parentNode.parentNode;
      if (row.rowIndex > 1) {
        var xhttp = new XMLHttpRequest();
        formData = new FormData();

        formData.append("screen", row.rowIndex - 1);
        formData.append("move", -1);

        xhttp.open("POST", "update_screen_order");
        xhttp.send(formData);

        row.parentNode.insertRow(row.rowIndex - 1).innerHTML = row.innerHTML;
        row.remove();
      }
    }
    function moveScreenDown(elem) {
      var row = elem.parentNode.parentNode;
      if (row.rowIndex < (row.parentNode.rows.length - 2)) {
        var xhttp = new XMLHttpRequest();
        formData = new FormData();

        formData.append("screen", row.rowIndex - 1);
        formData.append("move", 1);

        xhttp.open("POST", "update_screen_order");
        xhttp.send(formData);

        row.parentNode.insertRow(row.rowIndex + 2).innerHTML = row.innerHTML;
        row.remove();
      }
    }
    function deleteScreen(elem) {
      var index = elem.parentNode.parentNode.rowIndex;
      document.getElementById("ui_table").deleteRow(index);

      var xhttp = new XMLHttpRequest();
      xhttp.open("DELETE", "remove_screen?id=" + (index - 1));
      xhttp.send();
    }
    function editScreen(elem) {
      var index = elem.parentNode.parentNode.rowIndex - 1;
      window.location.href = "/edit_screen?screen=" + index;
    }
  </script>
</body>

</html>