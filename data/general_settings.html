<!DOCTYPE html>
<html>

<head>
  <title>UI Settings</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="utf-8" />
</head>

<body>
  <form>
    <table class="inlineTable" id="settingsTable">
      <tr>
        <td>Set Time Using</td>
        <td><button type="button" onclick="setTime(false)">
            System Time
          </button></td>
        <td><button type="button" onclick="setTime(true)">
            Custom Time
          </button></td>
      </tr>
      <tr>
        <td>Set Date Using</td>
        <td><button type="button" onclick="setDate(false)">
            System Date
          </button></td>
        <td><button type="button" onclick="setDate(true)">
            Custom Date
          </button></td>
      </tr>
      <tr>
        <td>Update Firmware</td>
        <td><input type="file" id="firmware" style="display:none;" onchange="uploadFirmware()"><button type="button"
            onclick="document.getElementById('firmware').click();">Upload</button></td>
      </tr>
    </table>
  </form>
  <script>
    function setTime(custom) {
      var date = new Date();

      if (custom) {
        var custom_time;
        while (custom_time == null) {
          custom_time = prompt("Set to (24hr time)", "hh:mm:ss");

          if (custom_time == null)  // Cancel the prompt if the user selects cancel
            return;

          custom_time = custom_time.match(/\b([0-1]?\d|2[0-3])\:[0-5]?\d\:[0-5]?\d\b/);
        }

        custom_time = custom_time[0]

        date.setHours(custom_time.substring(0, custom_time.indexOf(":")));
        date.setMinutes(custom_time.substring(custom_time.indexOf(":") + 1, custom_time.lastIndexOf(":")));
        date.setSeconds(custom_time.substring(custom_time.lastIndexOf(":") + 1));
      }
      if (confirm("Set to " + date.toTimeString().slice(0, 8)) == false) {
        return;
      }

      xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/set_time", true);
      xhttp.send("hours=" + date.getHours() + "&minutes=" + date.getMinutes() + "&seconds=" + date.getSeconds());
    }
    function setDate(custom) {
      var date = new Date();

      if (custom) {
        var custom_time;
        while (custom_time == null) {
          custom_time = prompt("Set to", "yy/mm/dd");

          if (custom_time == null)
            return;

          custom_time = custom_time.match(/\b\d\d\/(0?\d|1[0-2])\/([0-2]?\d|3[0-2])\b/);
        }

        custom_time = custom_time[0]

        date.setFullYear("20" + custom_time.substring(0, custom_time.indexOf("/")),
          custom_time.substring(custom_time.indexOf("/") + 1, custom_time.lastIndexOf("/")),
          custom_time.substring(custom_time.lastIndexOf("/") + 1));
        confirm("Set to " + date.getFullYear() + "/" + date.getMonth() + "/" + date.getDate());
      } else if (!confirm("Set to (yy/mm/dd) " + date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate())) {
        return;
      }

      xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/set_date", true);
      xhttp.send("year=" + date.getFullYear() + "&month=" + date.getMonth() + "&day=" + date.getDate() + "&weekday=" + date.getDay());
    }
    function uploadFirmware() {
      console.log("uploadFirmware");
      firmware = document.getElementById("firmware").files[0];  // file from input
      req = new XMLHttpRequest();
      formData = new FormData();

      formData.append("firmware", firmware);
      req.open("POST", '/update');
      req.send(formData);
    }
  </script>
</body>

</html>